<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Build Excel for Resume-Shots</title>
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
<div class="container mt-5">
    <h2 class="mb-3 text-center">Build Your Job Excel File</h2>
    <p class="lead text-center">
        Add one or more job rows manually, or let AI extract details from a pasted job description.
    </p>

    {% if error %}
        <div class="alert alert-danger">{{ error }}</div>
    {% endif %}

    <!-- Manual builder: rows table -->
    <h4>Step 1: Add / edit rows</h4>

    <form id="manualForm" method="post" action="{{ url_for('build_excel_manual') }}">
        <div class="table-responsive">
            <table class="table table-bordered align-middle">
                <thead class="table-light">
                <tr>
                    <th>#</th>
                    <th>Recruiter Email</th>
                    <th>Company Name</th>
                    <th>Job Position</th>
                    <th>Job Description</th>
                    <th>Company Website</th>
                    <th>Remove</th>
                </tr>
                </thead>
                <tbody id="rowsBody">
                <!-- rows added via JS -->
                </tbody>
            </table>
        </div>

        <button type="button" class="btn btn-outline-primary mb-3" id="addRowBtn">
            + Add Empty Row
        </button>

        <div class="mb-4">
            <button type="submit" class="btn btn-success">
                Download Excel &amp; Go to Upload Page
            </button>
            <a href="{{ url_for('upload_files') }}" class="btn btn-secondary ms-2">
                Back to Upload (without saving)
            </a>
        </div>
    </form>

    <hr>

    <!-- AI helper -->
    <h4>Step 2 (Optional): Use AI to add a row</h4>
    <p>
        Paste a full job posting below (from Glassdoor, LinkedIn, etc.).
        AI will extract the fields and add a new row to the table above. You can edit it afterwards.
    </p>

    <div class="mb-3">
        <label for="job_text" class="form-label">Job description text</label>
        <textarea class="form-control" id="job_text" rows="8"
                  placeholder="Paste the full job ad here..."></textarea>
    </div>
    <button type="button" class="btn btn-primary" id="aiAddRowBtn">
        Use AI to Extract &amp; Add Row
    </button>

    <div id="aiStatus" class="mt-3 text-muted"></div>
</div>

<script>
    let rowCount = 0;

    function addRow(data) {
        rowCount += 1;
        const row = document.createElement("tr");

        row.innerHTML = `
            <td>${rowCount}</td>
            <td><input type="email" class="form-control" name="email[]" value="${data?.["Email"] || ""}"></td>
            <td><input type="text" class="form-control" name="company[]" value="${data?.["Company Name"] || ""}"></td>
            <td><input type="text" class="form-control" name="position[]" value="${data?.["Job Position"] || ""}"></td>
            <td><textarea class="form-control" name="description[]" rows="3">${data?.["Job Description"] || ""}</textarea></td>
            <td><input type="text" class="form-control" name="website[]" value="${data?.["Website"] || ""}"></td>
            <td class="text-center">
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeRow(this)">✕</button>
            </td>
        `;
        document.getElementById("rowsBody").appendChild(row);
    }

    function removeRow(btn) {
        const row = btn.closest("tr");
        if (row) row.remove();
    }

    document.getElementById("addRowBtn").addEventListener("click", function () {
        addRow({});
    });

    // AI: send job_text to backend, append returned row
    document.getElementById("aiAddRowBtn").addEventListener("click", function () {
        const jobText = document.getElementById("job_text").value.trim();
        const statusEl = document.getElementById("aiStatus");

        if (!jobText) {
            alert("Please paste a job description first.");
            return;
        }

        statusEl.textContent = "Thinking with AI…";

        $.ajax({
            url: "{{ url_for('build_excel_ai') }}",
            type: "POST",
            data: { job_text: jobText },
            success: function (resp) {
                if (!resp.success) {
                    alert("AI error: " + (resp.message || "Unknown error"));
                    statusEl.textContent = "";
                    return;
                }
                addRow(resp.row);
                statusEl.textContent = "✅ Row added using AI. You can edit it above.";
                document.getElementById("job_text").value = "";
            },
            error: function (xhr, status, error) {
                alert("AI call failed: " + (xhr.responseText || error));
                statusEl.textContent = "";
            }
        });
    });

    // Start with one empty row so the screen isn't blank
    addRow({});
</script>
</body>
</html>
